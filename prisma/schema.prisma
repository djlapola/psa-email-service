generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model EmailLog {
  id        String    @id @default(uuid())
  to        String
  from      String
  subject   String
  template  String
  status    String    @default("queued") // queued, sending, sent, delivered, bounced, complained, failed
  sendgridMessageId  String?
  tenantId  String?
  metadata  Json?
  error     String?
  attempts  Int       @default(0)
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([tenantId])
  @@index([status])
  @@index([template])
  @@index([createdAt])
  @@index([sendgridMessageId])
}

model WebhookDelivery {
  id          String   @id @default(uuid())
  emailLogId  String
  targetUrl   String
  event       String   // email.bounced, email.complained, email.delivered
  payload     Json
  status      String   @default("pending") // pending, sent, failed
  attempts    Int      @default(0)
  lastError   String?
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([emailLogId])
  @@index([status])
}

model TenantEmailConfig {
  id                     String   @id @default(uuid())
  tenantId               String   @unique
  fromEmail              String?  // e.g., support@acme.skyrack.com
  fromName               String?  // e.g., Acme Support
  replyTo                String?
  domain                 String?  // e.g., acme.skyrack.com
  domainVerified         Boolean  @default(false)
  sendgridDomainId       String?  // SendGrid's domain authentication ID
  cloudflareDnsRecordIds Json?    // Array of Cloudflare record IDs for cleanup
  receivingEnabled       Boolean  @default(false)  // Whether inbound email is enabled
  receivingVerified      Boolean  @default(false)  // Whether MX record is verified
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@map("tenant_email_configs")
}

model EmailTemplate {
  id          String   @id @default(uuid())
  tenantId    String?  // null = system default
  name        String   // e.g., 'ticket-created'
  displayName String   // e.g., 'Ticket Created Notification'
  description String?  // What this template is for
  subject     String   // Email subject with {{variables}}
  htmlBody    String   // HTML body with {{variables}}
  textBody    String?  // Plain text fallback
  variables   Json     // List of available variables for this template
  isSystem    Boolean  @default(false)  // true = default, can't delete
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([name])
  @@index([isSystem])
}

model TenantEmailDomain {
  id                String    @id @default(uuid())
  tenantId          String
  domain            String    // e.g., "deskside.com"
  status            String    @default("pending") // "pending", "verified", "failed"

  // SendGrid domain authentication
  sendgridDomainId  String?   // SendGrid authenticated domain ID

  // DNS records the tenant needs to add
  dnsRecords        Json?     // Array of { type: "CNAME"|"TXT", host: "...", value: "...", valid: boolean }

  // Verification
  lastVerifiedAt    DateTime?
  verifiedAt        DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([tenantId, domain])
  @@index([tenantId])
  @@index([domain])
  @@map("tenant_email_domains")
}

model EmailMessageId {
  id        String   @id @default(uuid())
  tenantId  String
  ticketId  String
  commentId String?  // null if this is the original ticket creation email
  messageId String   // The Message-ID header value from the email
  createdAt DateTime @default(now())

  @@index([messageId])
  @@index([tenantId, ticketId])
}
