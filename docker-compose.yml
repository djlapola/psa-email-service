services:
  email-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: email-service
    restart: unless-stopped
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=production
      - PORT=4001
      - DATABASE_URL=postgresql://cp_admin:d2210ccc16d4c580560773913c10b6ca@cp-postgres:5432/email_service?schema=public
      - RESEND_API_KEY=${RESEND_API_KEY}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@yourpsa.com}
      - EMAIL_SERVICE_API_KEY=${EMAIL_SERVICE_API_KEY}
      - RESEND_WEBHOOK_SECRET=${RESEND_WEBHOOK_SECRET:-}
      - CONTROL_PLANE_WEBHOOK_URL=${CONTROL_PLANE_WEBHOOK_URL:-http://cp-backend:4000/api/webhooks/email}
      - PSA_WEBHOOK_URL=${PSA_WEBHOOK_URL:-}
    networks:
      - control-plane_cp-network
    # Note: depends on cp-postgres from control-plane network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  control-plane_cp-network:
    external: true
